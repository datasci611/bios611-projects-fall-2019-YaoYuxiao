---
title: "project3_report"
author: "YuxiaoYao"
date: "11/18/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
Non-profit Urban Ministries of Durham (UMD) connects poor and homeless neighbors to food, shelter and a future. They connect with the community to end homelessness and fight poverty by offering food, shelter and a future to neighbors in need. Here is the official website of UMD: http://www.umdurham.org/. This project is aiming to help UMD to improve their services and get prepared for future works.


## Datasets
Datasets are provided by UMD, which includes clients' information, entry and exit information, clients' health insurance conditions, income conditions and disability conditions at entry and at exit, provider information. For this project, I will use CLIENT, ENTRY_EXIT, EE_UDES, HEALTH_INS_ENTRY, HEALTH_INS_EXIT, INCOME_ENTRY and INCOME_EXIT. 
Some variables are shown below:  

* CLIENT: Client ID, Client Age at Entry, Client Gender, Client Primary Race, Client Ethnicity, Client Veteran Status
* ENTRY_EXIT: Entry Date, Exit Date, Destination, Reason for Leaving
* EE_UDES: Client Location, Relationship to Head of Household, Prior Living Situation, Length of Stay in Previous Place
* HEALTH_INS_ENTRY: Covered (Entry), Health Insurance Type (Entry), Health Insurance Start Date (Entry)
* HEALTH_INS_EXIT: Covered (Exit), Health Insurance Type (Exit), Health Insurance Start Date (Exit)
* INCOME_ENTRY: Receiving Income (Entry), Income Source (Entry), Monthly Amount (Entry)
* INCOME_EXIT: Receiving Income (Exit), Income Source (Exit), Monthly Amount (Exit)


## Questions 
Since the main purpose of the project is to help UMD with desicion making, here are some of questions I am interested in. First, the demographic information helps the UMD to know basic information such as gender, age, race and ethnicity of the client population. Then I would like to focus on entry and exit analysis including the number of days clients stayed and the reasons why they left. The results can provide the UMD with some suggestions about their programs. So here are some questions I would like to analyze:

1. Demographics
  + What are the size, structure, and distribution of the clinet population at entry?
  + What are the health insurance and income conditions at entry and at exit?

2. Entry and Exit
  + How many clients entried the UMD? What is the distribution of their entry time?
  + How long did they stay at the UMD?
  + Why did they leave the UMD?


## Data preparation
For data preparation, I processed the data using Python. I cleaned data by removing missing values and irrelevant variables. Also, I converted data type and calculated number of days clients stayed. Then I combined some tables together for later use.

```{r prep ,include = FALSE,message=FALSE,warning=FALSE}
library(tidyverse)

merged_data=read_tsv("C:/Users/yaoyu/OneDrive/Documents/bios611-projects-fall-2019-YaoYuxiao/project_3/data/merged_data.tsv")
merged_data_client = read_tsv("C:/Users/yaoyu/OneDrive/Documents/bios611-projects-fall-2019-YaoYuxiao/project_3/data/merged_data_client.tsv")

# clean column names
names(merged_data)<-make.names(names(merged_data))
names(merged_data_client)<-make.names(names(merged_data_client))

str(merged_data_client)

demographic_data = merged_data_client %>%
  select(Client.ID,Client.Age.at.Entry,Client.Gender,Client.Primary.Race,Client.Ethnicity,Client.Veteran.Status)

demographic_data

ee_data = merged_data %>%
  select(Client.ID,Entry.Date,Exit.Date,Destination,Reason.for.Leaving,stay_days)
ee_data$stay_days=str_remove_all(ee_data$stay_days, " days 00:00:00.000000000")
ee_data
```

## Demographics
### Age and Gender
```{r, echo=FALSE}
male_sub=subset(demographic_data,(Client.Gender == "Male"))

male_sub = male_sub%>%
  group_by(Client.Age.at.Entry) %>%
  summarise(count= -1 * n())


plot1.1=ggplot(demographic_data,mapping=aes(x=Client.Age.at.Entry))+
  geom_bar(subset(demographic_data,(Client.Gender == "Female")),mapping=aes(x=Client.Age.at.Entry),fill='pink2') + 
  geom_bar(male_sub,mapping=aes(x=Client.Age.at.Entry,y=count),stat = "identity",fill='skyblue2') +
  coord_flip()
  
plot1.1
```
From the Figure 1 we can see distributions of age and gender of clients. Apparently,men are more than women in the client population. Ages of clients starts from 18 to 80. Age of 50 has most clients for both men and women. The distribution of different ages for men and women are similar: the number the old people who are more than 60 years old is relatively small, and there is a generally decreasing trend as the age goes down from 50.

### Race and Ethnicity
```{r, echo=FALSE}
race=demographic_data %>%
  drop_na()%>%
  group_by(Client.Primary.Race) %>%
  summarise(count= n())
race
# TODO remove (HUD)
plot1.2<- ggplot(race, aes(x="", y=count, fill=Client.Primary.Race))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_brewer(palette = "YlGnBu") 
plot1.2

eth=demographic_data %>%
  drop_na()%>%
  group_by(Client.Ethnicity) %>%
  summarise(count= n())
eth
plot1.3<- ggplot(eth, aes(x="", y=count, fill=Client.Ethnicity))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_brewer(palette = "YlGnBu") 
plot1.3
```
As for primary race of clients, nearly 75% of clients are black or African American. and nearly 25% of clients are white. Other races like Asian are near to 0 according to the databases. More than 97% of the clients are not Hispanic or Latino.

### Veteran Status
```{r, echo=FALSE}
veteran=demographic_data %>%
  drop_na()%>%
  group_by(Client.Veteran.Status) %>%
  summarise(count= n())

veteran

plot1.4<- ggplot(veteran, aes(x="", y=count, fill= Client.Veteran.Status))+
  geom_bar(width = 1, stat = "identity")+
  coord_polar("y", start=0)+
  scale_fill_brewer(palette = "YlGnBu") 
plot1.4
```
According to data from the Department of Veterans Affairs, there were around 20.4 million U.S. veterans in 2016, representing less than 10% of the total U.S. adult population. Based on our datasets, 12.2% of the clients are veteran. 

### Health Insurance and Income Conditions
Only less than 2% of the clients have health insurance at both entry and exit. Less than 1% of the clients have income at both entry and exit. The distributions of insurance types and the income recources almost keep unchanged before and after being served by the UMD.

## Entry and Exit
### How many clients entried the UMD every month? 
```{r, echo=FALSE}
client_monthly=ee_data %>%
  separate(Entry.Date, sep = "-", into = c("Year", "Month", "Day"))%>%
  group_by(Year,Month) %>%
  summarise(client_sum=n())
client_monthly
client_monthly$yearmonth<-as.factor(paste(client_monthly$Year,client_monthly$Month,sep="-"))


plot2.1=ggplot(client_monthly,aes(as.numeric(yearmonth),client_sum))+
  geom_point()+
  geom_text(aes(label=client_sum),vjust=-0.8,size=3)+
  geom_line(size=1,color='skyblue3') +
  labs(x="Month",y="Client Number",title = "Fig2.1 Number of Clients Changes by Month")
plot2.1
```
The figue shows numbers of new clients every month from Augest 2015 to October 2019. The peak is in May 2016 with 183 new clients. From then on, the number of new  clients decreased to around 70. However, it increased a little bit in the past few months since June 2019. The average new client number monthly in 2019 is 57.1.

### How long did they stay at the UMD? Why did they leave the UMD?
```{r,echo=FALSE}
ee_data$stay_days_cut <- cut(suppressWarnings(as.numeric(ee_data$stay_days)), breaks = c(0,30,60,90,120,150,180,210,240,270,Inf), labels = c('0-30','31-60','61-90','91-120','121-150','151-180','181-210','211-240','241-270','271-300'), right = TRUE)

stay_data = ee_data %>%
  drop_na(stay_days_cut)
stay_data_group = stay_data%>%
  group_by(stay_days_cut)%>%
  summarise(client_num=n())

stay_data_group

plot2.2=ggplot(stay_data,aes(stay_days_cut,fill=Reason.for.Leaving))+
  geom_bar(width = 0.9, na.rm=TRUE)+
  coord_flip() +
  theme(legend.position = "bottom",legend.text = element_text(size = 8))+
  labs(x="Days Stayed",y="Count",title = "Fig2.2 Number of Days Clients Stayed and Reasons for Leaving")+
  guides(fill = guide_legend(ncol = 2))

plot2.2
```
The figure shows number of days clients stayed at the UMD and the reasons why they left. We can see that most of the clients stayed less than 30 days, which is more than 4 times of number of clients who stayed 31-60 days. The most common reasons for leaving are "Other" "Unknown/Disappeared", which suggests we need more precise data about reasons for leaving. Besides, "Left for housing opportunities before completing program" is the most popular reason as we know. 

### Where did they go after leaving?
```{r,echo=FALSE}
dest_top10=ee_data%>%
  drop_na(Destination)%>%
  group_by(Destination)%>%
  summarise(client_num=n())%>%
  filter(client_num>44)%>%
  arrange(desc(client_num))

dest_top10

plot2.3=ggplot(dest_top10,aes(x="", y=client_num, fill= Destination))+
  geom_bar(stat='identity',width = 1, na.rm=TRUE)+
  coord_polar("y", start=0)

plot2.3
```
According to the figure, about one third of clients stay or live with friends with temporary tenure after leaving the UMD. About one fourth of clients did not complete exit interview, this coincide with "Unknown/Disappeared" leaving reason shown before. About 11% clients stay or live with family with temporary tenure after leaving the UMD. These are the top three reasons for leaving.


## Conclusion and Discussion

* Totally, there are 2,075 individual clients were served by the UMD from Augest 2015 to October 2019. Men are more than women in the client population and ages varies from 18 to 80. Most of clients are 40-60 years old at entry.
* Nearly 75% of clients are black or African American. More than 97% of the clients are not Hispanic or Latino.
* 12.2% of the clients are veteran, which is higher than the percentage on a national scale.
* From May 2016 to now, the number of new  clients decreased from 183 to around 70. However, it increased a little bit in the past few months since June 2019.
* Most of the clients stayed less than 30 days, which is more than 4 times of number of clients who stayed 31-60 days. 
* "Staying or living with friends, temporary tenure","No exit interview completed" and "Staying or living with family, temporary tenure" are the top three destinations of clients after leaving the UMD.








